---
title: 分布式相关知识点
date: 2020-07-25 13:28:06
tags:
	- 分布式
	- 面试
categories:
	- 面试
typora-root-url: ../..
---

记录分布式相关知识点。

<!--more-->

# 分布式锁

https://blog.csdn.net/huyaowei789/article/details/87873977

任何一个分布式系统都无法同时满足**CAP**，最多只能同时满足两项：

- 一致性（Consistency）：所有用户看到一致的数据。
- 可用性（Availability）：非故障的结点在合理的时间内返回合理的响应。
- 分区容错性（Partition tolerance）：容忍网络中断。

## 数据库实现分布式锁

### 基于数据库表实现

利用主键冲突实现，当一个结点执行某个方法前，尝试向数据库中插入一条数据（如**以方法名为唯一索引**的数据），若插入成功，表示当前没有其他节点在执行相同方法，在方法执行完毕删除该行数据。

### 基于数据库的排他锁实现

在执行数据操作之前，使用**for update**查询为该数据加上排他锁，执行完数据操作后，通过commit释放所。

### 分析

- 依赖于数据库的可用性，而数据库是一个单点，一旦数据库不可用，会导致整个业务不可用。数据库可以采用双机部署、主备切换。

- 没有锁失效机制，一旦解锁失败，就会导致其他线程无法获取锁。可以通过一个字段记录失效时间，并且需要定时任务清除失效的数据。

- 非重入的。可以增加字段记录锁的机器编号和线程编号。

## Redis实现分布式锁

基于Redis的setnx()、expire()、getset()方法实现分布式锁。

- setnx(key, value)：setnx的含义是set if not exist，该方法具有原子性。通常key为锁名，value为超时时间。如果key不存在，则设置当前key成功，返回1。否则检查当前key是否过期，如果已过期，可以获得锁。
- expire(key, timeout)：在Redis中设置key的过期时间，防止某个程序崩溃了无法释放锁。
- getset(key, newValue)：该方法具有原子性，替换key的value为newValue并返回value。可以通过该方法实现锁的续时。

### 分析

性能高，但是实现复杂，且需要自己根据需求配置超时时间。

## Zookeeper实现分布式锁

### zk结点类型

- **持久结点：**默认的结点类型，创建结点的客户与zk断开连接后，结点依然存在。
- **持久顺序结点：**在创建结点时，zk根据创建的时间顺序给结点名称进行编号。

- **临时结点：**当创建结点的客户与zk断开连接后，临时结点会被删除。
- **临时顺序结点：**创建结点时，zk根据创建的时间顺序给结点名称进行编号。

### 锁过程

**获取锁：**在Zookeeper中创建一个持久结点Lock，当一个客户获取锁时，需要在Lock结点下创建一个临时顺序结点，若该临时顺序结点是最靠前的一个结点，则获取锁成功。否则向该结点的前一个结点注册**Watcher**来监听前一个结点的状态。

**释放锁：**当最靠前的结点任务完成或者崩溃时，该结点会被删除，后面一个结点会收到通知，并再次检查自己是否是当前最考前的结点，如果是则该节点获取到锁。

### 分析

高可用，可重入，易实现。但是Zookeeper中只能通过leader结点创建和删除结点，因此创建结点（加锁）和删除结点（释放锁）的性能不如Redis。



# 分布式事务

